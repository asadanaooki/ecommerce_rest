<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.mapper.ProductMapper">
  <select id="selectByPrimaryKey" resultType="com.example.entity.Product">
    SELECT *
    FROM product
    WHERE product_id = #{productId}
  </select>
  
  <select id="selectViewByPrimaryKey" resultType="com.example.entity.view.ProductCoreView">
    SELECT *
    FROM vw_product_core
    WHERE product_id = #{productId}
  </select>

  <select id="searchProducts" resultType="com.example.dto.ProductCardDto">
    SELECT v.product_id, v.product_name, v.price_incl,
      (v.stock &lt;= 0) AS out_of_stock,
      <choose>
        <!-- ログイン中だけ JOIN があるので f.user_id をそのままブール式で判定 -->
        <when test="userId != null">
        f.user_id IS NOT NULL 
        </when>
        <!-- 未ログインは固定で FALSE -->
         <otherwise>
          FALSE
         </otherwise>
      </choose>
       AS is_fav
    FROM vw_product_core v
    <if test="userId != null">
    LEFT JOIN favorite f
      ON f.product_id = v.product_id
      AND f.user_id = #{userId}
    </if>
    WHERE v.<include refid="common.OnlyPublished"/>
    <if test="keywords.size() > 0">
      AND (
      <foreach collection="keywords" item="kw" separator="OR ">
        v.product_name LIKE CONCAT('%', #{kw}, '%')
      </foreach>
      )
    </if>
    ORDER BY
    <choose>
      <when test="sort.name() == 'NEW'">
        v.created_at DESC 
      </when>
      <when test="sort.name() == 'HIGH'">
        v.price_incl DESC 
      </when>
      <when test="sort.name() == 'LOW'">
        v.price_incl ASC 
      </when>
    </choose>
    , v.product_id DESC
    LIMIT #{offset}, #{size}
  </select>
  
  <select id="countProducts" resultType="int">
    SELECT COUNT(*)
    FROM product
    WHERE <include refid="common.OnlyPublished"/>
    <if test="keywords.size() > 0">
      AND (
      <foreach collection="keywords" item="kw" separator="AND ">
        product_name LIKE CONCAT('%', #{kw}, '%')
      </foreach>
      )
    </if>
  </select>

  <select id="findProductDetail" resultType="com.example.dto.ProductDetailDto">
    select
      v.product_id,
      v.product_name,
      v.product_description,
      v.price_incl,
      (v.stock &lt;= 0) AS out_of_stock,
      coalesce(rs.avg, 0) as rating_avg,
      coalesce(rs.cnt, 0) as review_count,
      <choose>
        <when test="userId != null">
        f.user_id IS NOT NULL 
        </when>
        <!-- 未ログインは固定で FALSE -->
         <otherwise>
          FALSE
         </otherwise>
      </choose>
      as is_fav
    from vw_product_core v
    left join (
        select
          r.product_id,
          round(avg(r.rating), 1) as avg,
          count(*) as cnt
        from review r
        group by r.product_id
    ) rs on rs.product_id = v.product_id
      <if test="userId != null">
        left join favorite f
          on f.product_id = v.product_id
          and f.user_id = #{userId}
      </if>
    where v.product_id = #{productId}
      and <include refid="common.OnlyPublished"/>
  </select>
  
  <update id="decreaseStock">
    update product
      set stock = stock - #{qty}
    where product_id = #{productId}
  </update>
  
</mapper>
