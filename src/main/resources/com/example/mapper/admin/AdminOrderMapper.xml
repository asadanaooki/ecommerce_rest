<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.mapper.admin.AdminOrderMapper">

  <select id="selectPage" resultType="com.example.dto.admin.AdminOrderRowDto">
    select 
      order_id,
      lpad(cast(order_number as char), 4, '0') as order_number,
      created_at,
      name,
      grand_total_incl,
      order_status,
      payment_status
    from `order`
    <where>
      <if test="req.keyword != null">
        and (
         replace(name,' ','') like concat('%', #{req.keyword}, '%')
         or order_number like concat('%', #{req.keyword}, '%')
        )
      </if>
      <if test="req.orderStatus != null">
        and order_status = #{req.orderStatus}
      </if>
      <if test="req.paymentStatus != null">
        and payment_status = #{req.paymentStatus}
      </if>
      <if test="req.createdFrom != null">
        AND created_at &gt;= #{req.createdFrom} 
      </if>
      <if test="req.createdTo != null">
        AND created_at &lt;= #{req.createdTo} 
      </if>
    </where>
    order by ${req.sortField.field} ${req.sortDirection}
    limit #{limit} offset #{offset}
  </select>

  <select id="count" resultType="int">
    select count(*)
    from `order`
    <where>
      <if test="keyword != null">
        and (
         replace(name,' ','') like concat('%', #{keyword}, '%')
         or order_number like concat('%', #{keyword}, '%')
        )
      </if>
      <if test="orderStatus != null">
        and order_status = #{orderStatus}
      </if>
      <if test="paymentStatus != null">
        and payment_status = #{paymentStatus}
      </if>
      <if test="createdFrom != null">
        AND created_at &gt;= #{createdFrom} 
      </if>
      <if test="createdTo != null">
        AND created_at &lt;= #{createdTo} 
      </if>
    </where>
  </select>
  
  <resultMap type="com.example.dto.admin.AdminOrderDetailDto" id="AdminOrderDetailMap">
    <!-- Order本体 -->
    <id     property="orderId"           column="order_id"/>
    <result property="orderNumber"       column="order_number"/>
    <result property="itemsSubtotalIncl" column="items_subtotal_incl"/>
    <result property="shippingFeeIncl"   column="shipping_fee_incl"/>
    <result property="codFeeIncl"        column="cod_fee_incl"/>
    <result property="grandTotalIncl"    column="grand_total_incl"/>
    <result property="orderStatus"       column="order_status"/>
    <result property="shippingStatus"    column="shipping_status"/>
    <result property="paymentStatus"     column="payment_status"/>
    <result property="createdAt"         column="created_at"/>
    <result property="name"              column="snap_user_name"/>
    <result property="email"             column="email"/>
    <result property="postalCode"        column="snap_postal_code"/>
    <result property="address"           column="address"/>
    <result property="phoneNumber"       column="phone_number"/>
  
    <!-- Itemsコレクション -->
    <collection property="items" ofType="com.example.dto.admin.AdminOrderDetailItemDto">
      <result property="productId"     column="product_id"/>
      <result property="sku"           column="sku"/>
      <result property="productName"   column="snap_product_name"/>
      <result property="unitPriceIncl" column="unit_price_incl"/>
      <result property="qty"           column="qty"/>
      <result property="subtotalIncl"  column="subtotal_incl"/>
    </collection>
  </resultMap>

  
  <select id="selectOrderDetail" resultMap="AdminOrderDetailMap">
    SELECT
      o.order_id,
      LPAD(CAST(o.order_number AS CHAR), 4, '0') AS order_number,
      o.items_subtotal_incl,
      o.shipping_fee_incl,
      o.cod_fee_incl,
      o.grand_total_incl,
      o.order_status,
      o.shipping_status,
      o.payment_status,
      o.created_at,
      o.name as snap_user_name,
      u.email,
      o.postal_code as snap_postal_code,
      o.address,
      u.phone_number,

      i.product_id,
      v.sku,
      i.product_name as snap_product_name,
      i.unit_price_incl,
      i.qty,
      i.subtotal_incl
    FROM `order` o
    JOIN `user` u
      ON u.user_id = o.user_id
    LEFT JOIN order_item i
      ON i.order_id = o.order_id
    JOIN vw_product_core v
      ON v.product_id = i.product_id
    WHERE o.order_id = #{orderId}
    ORDER BY i.product_id
  </select>

</mapper>
