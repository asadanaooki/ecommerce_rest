<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.mapper.admin.AdminOrderMapper">

  <select id="selectPage" resultType="com.example.dto.admin.AdminOrderRowDto">
    select 
      order_id,
      lpad(cast(order_number as char), 4, '0') as order_number,
      created_at,
      name,
      grand_total_incl,
      order_status,
      payment_status
    from `order`
    <where>
      <if test="req.keyword != null">
        and (
         replace(name,' ','') like concat('%', #{req.keyword}, '%')
         or order_number like concat('%', #{req.keyword}, '%')
        )
      </if>
      <if test="req.orderStatus != null">
        and order_status = #{req.orderStatus}
      </if>
      <if test="req.paymentStatus != null">
        and payment_status = #{req.paymentStatus}
      </if>
      <if test="req.createdFrom != null">
        AND created_at &gt;= #{req.createdFrom} 
      </if>
      <if test="req.createdTo != null">
        AND created_at &lt;= #{req.createdTo} 
      </if>
    </where>
    order by ${req.sortField.field} ${req.sortDirection}
    limit #{limit} offset #{offset}
  </select>

  <select id="count" resultType="int">
    select count(*)
    from `order`
    <where>
      <if test="keyword != null">
        and (
         replace(name,' ','') like concat('%', #{keyword}, '%')
         or order_number like concat('%', #{keyword}, '%')
        )
      </if>
      <if test="orderStatus != null">
        and order_status = #{orderStatus}
      </if>
      <if test="paymentStatus != null">
        and payment_status = #{paymentStatus}
      </if>
      <if test="createdFrom != null">
        AND created_at &gt;= #{createdFrom} 
      </if>
      <if test="createdTo != null">
        AND created_at &lt;= #{createdTo} 
      </if>
    </where>
  </select>
  
  <resultMap type="com.example.dto.admin.AdminOrderDetailDto" id="AdminOrderDetailMap">
    <id property="orderId" column="order_id"></id>
    <collection property="items" ofType="com.example.dto.admin.AdminOrderDetailItemDto"></collection>
  </resultMap>
  
  <select id="selectOrderDetail" resultMap="AdminOrderDetailMap">
    SELECT
      o.order_id,
      LPAD(CAST(o.order_number AS CHAR), 4, '0') AS order_number,
      o.items_subtotal_incl,
      o.shipping_fee_incl,
      o.grand_total_incl,
      o.order_status,
      o.shipping_status,
      o.payment_status,
      o.created_at,
      o.name,
      CONCAT_WS(' ', u.last_name_kana, u.first_name_kana) AS name_kana,
      u.email,
      u.postal_code,
      o.address,
      u.phone_number,

      i.product_id,
      i.product_name,
      i.unit_price_incl,
      i.qty,
      i.subtotal_incl
    FROM `order` o
    JOIN `user` u
      ON u.user_id = o.user_id
    LEFT JOIN order_items i
      ON i.order_id = o.order_id
    WHERE o.order_id = #{orderId}
    ORDER BY i.product_id
  </select>

</mapper>
