<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.mapper.admin.AdminInventoryMapper">

  <select id="search" resultType="com.example.dto.admin.AdminInventoryDto">
    SELECT p.product_id,
           p.sku,
           p.product_name,
           p.price_excl,
           (p.stock - p.reserved) as available,
           p.updated_at
     FROM product p
     <where>
       <if test="req.minAvailable != null">
        and (p.stock - p.reserved) &gt;= #{req.minAvailable}
      </if>
      <if test="req.maxAvailable != null">
        and (p.stock - p.reserved) &lt;= #{req.maxAvailable}
      </if>
      <if test="req.stockStatus != null">
        <choose>
          <when test="req.stockStatus.name().equals('OUT_OF_STOCK')">
            and (p.stock - p.reserved) = 0
          </when>
          <when test="req.stockStatus.name().equals('LOW_STOCK')">
            and (p.stock - p.reserved) &gt; 0
            and (p.stock - p.reserved) &lt;= #{threshold}
          </when>
          <when test="req.stockStatus.name().equals('IN_STOCK')">
            and (p.stock - p.reserved) &gt; #{threshold} 
          </when>
        </choose>
      </if>
     </where>
     order by
      <choose>
        <when test="req.sortField.field.equals('stock_status')">
          field(
            case
              when (p.stock - p.reserved) = 0 then 'OUT_OF_STOCK'
              when (p.stock - p.reserved) &lt;= #{threshold} then 'LOW_STOCK'
              else 'IN_STOCK'
            end,
            'OUT_OF_STOCK','LOW_STOCK','IN_STOCK'
          ) 
        </when>
        <otherwise>
          ${req.sortField.field}
        </otherwise>
      </choose>
      ${req.sortDirection},
      p.sku asc
      limit #{limit} offset #{offset}
  </select>

  <select id="count" resultType="int">
    select count(*)
    from product p
    <where>
      <if test="req.minAvailable != null">
        and (p.stock - p.reserved) &gt;= #{req.minAvailable}
      </if>
      <if test="req.maxAvailable != null">
        and (p.stock - p.reserved) &lt;= #{req.maxAvailable}
      </if>
      <if test="req.stockStatus != null">
        <choose>
          <when test="req.stockStatus.name().equals('OUT_OF_STOCK')">
            and (p.stock - p.reserved) = 0
          </when>
          <when test="req.stockStatus.name().equals('LOW_STOCK')">
            and (p.stock - p.reserved) &lt;= #{threshold}
          </when>
          <when test="req.stockStatus.name().equals('IN_STOCK')">
            and (p.stock - p.reserved) &gt; #{threshold} 
          </when>
        </choose>
      </if>
    </where>
  </select>
  
  <select id="find" resultType="com.example.dto.admin.AdminInventoryDetailDto">
    SELECT p.product_id,
           p.sku,
           p.product_name,
           p.price_excl,
           p.stock,
           p.reserved,
           (p.stock - p.reserved) as available,
           p.updated_at
    FROM product p
    WHERE p.product_id = #{productId}
  </select>
  
  <update id="updateInventory">
    update product
    set stock = #{req.stock},
        reserved = #{req.reserved}
    where product_id = #{productId}
  </update>

</mapper>
