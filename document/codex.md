# 対応状況チェック用（本ファイル向け）

- 生成日時: 2025-08-10 09:39:44
- 総項目数: 21
- チェックの入れ方: 対応完了した項目は `[ ]` を `[x]` に変更してください。

---
# セキュリティ／プライバシー

- [x ] **JwtUtil が秘密鍵をハードコーディングしており、有効期限なしのトークンを発行しているため、トークンが推測可能で無期限に有効になる**  
  対応: 秘密鍵を外部設定に移し、トークンの有効期限・リフレッシュ処理を有効化する。

- [ ] **Login が HttpOnly や Secure 属性なしで Cookie を設定しており、スクリプトからトークンへアクセス可能になる**  
  対応: Cookie 設定時に `.httpOnly(true)` と `.secure(true)` を追加する。

- [ ] **changePassword がエンコード済みパスワードを equals で比較しており、現在のパスワード検証を正しく行わずに変更できる**  
  対応: `passwordEncoder.matches(req.getCurrentPassword(), user.getPasswordHash())` を使用し、条件を反転する。

---

## トランザクション整合性／信頼性

- [ ] **在庫数を減算する際に残量チェックを行っておらず、負の在庫が発生する可能性がある**  
  対応: `stock >= qty` の場合のみ更新し、更新件数を検証する。

- [ ] **Checkout 内でトランザクション中に確認メールを送信しており、メール送信失敗時に長時間のロックやロールバックが発生するリスクがある**  
  対応: トランザクションコミット後に送信する outbox パターンや非同期メールキューを使用する。

---

## パフォーマンス／スケーラビリティ

- [ ] **JwtUtil.parser() がリクエストごとに秘密鍵とパーサーを再生成しており、不要なオブジェクト生成コストが発生している**  
  対応: `SecretKey` と `JwtParser` を静的シングルトンとしてキャッシュする。

- [ ] **レビュー平均をページごとにメモリ上で計算しており、大規模データで CPU 負荷や誤った合計値が発生する**  
  対応: DB に `AVG(rating)` を計算させる、または集計列を使用する。

---

## 可観測性／監査

- [ ] **例外がログ出力されずに返却されており、診断のための痕跡が残らない**  
  対応: 各 `@ExceptionHandler` 内で構造化ログを追加する。

- [ ] **認証イベントが監査ログに記録されず、攻撃検知が困難**  
  対応: 成功・失敗を含むログイン試行を記録する。

---

## 運用／リカバリ

- [ ] **期限切れの登録／リセットトークンが削除されず、テーブル膨張や手動削除のリスクがある**  
  対応: 定期的なクリーンアップや TTL による自動削除を実装する。

- [ ] **トランザクション内のメール送信にリトライや補償処理がなく、メールサーバ障害時にリカバリが困難**  
  対応: リトライ可能な非同期送信キューに入れる。

---

## コンプライアンス（法務／会計／税／丸め）

- [ ] **税額計算が常に切り捨て（floor）になっており、税額不足や会計ルール違反の可能性がある**  
  対応: `RoundingMode.HALF_UP` または地域ごとの丸め設定を使用する。

---

## データモデル／アーキテクチャ

- [ ] **注文 ID がカート ID を使い回しており、概念が密結合し、再利用や予測可能性による衝突リスクがある**  
  対応: 独立した一意の注文 ID を生成する。

---

## QA／テスト

- [ ] **AuthServiceTest が単体テストレベルで @SpringBootTest を使っており、実行が遅い（TODO コメントでも懸念されている）**  
  対応: モックを使ったスライス／ユニットテストに置き換え、テストスイートの高速化を図る。

- [ ] **AdminProductServiceTest がコンバータをモックしており、変換ロジックが未検証**  
  対応: 実際の MapStruct コンバータを使用するか、マッピングを検証する統合テストを追加する。

---

## コード（コードスメル、重複、スタイル）

- [ ] **二重波括弧初期化（double-brace initialization）が匿名クラスとメモリリークの可能性を生む**  
  対応: エンティティを生成してフィールドを個別に設定するか、ビルダーを使用する。

- [ ] **ApiResponse.data にアクセス修飾子がなく可変で、カプセル化が崩れている**  
  対応: `private final Object data` にして getter のみ提供する。

---

## 仕様（API契約、設定、エラーレスポンス）

- [ ] **`/register/verify` がトークンを検証やサイズ制限なしで受け付けている**  
  対応: `@Size` / `@Pattern` 制約を追加し、ログにトークンが出ないよう POST に変更することを検討する。

- [ ] **Login エンドポイントが 200 と空ボディを返しており、トークンやユーザ情報を返す REST の一般的な仕様と異なる**  
  対応: トークンやユーザ情報を含む構造化 JSON を返す。

---

## 機能（業務ロジック、不足、エッジケース）

- [ ] **事前登録確認で生トークンを使用しているが、DB にはハッシュ値を保存しているため正しいリンクでも失敗する**  
  対応: 受信したトークンをハッシュ化してから検索し、ハッシュ値同士で比較する。

- [ ] **レビュー平均が現在のページ内のみで計算されており、レビュー数が多い商品で全体平均が誤る**  
  対応: 全レビュー対象で SQL により平均を計算するか、集計値を保持する。
