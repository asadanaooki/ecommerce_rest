# 対応状況チェック用（本ファイル向け）

- 生成日時: 2025-08-10 09:43:25
- チェック追加件数: 382
- 使い方: 完了した項目は `[ ]` を `[x]` に変更してください。

---
# E-コマース REST API セキュリティ＆コード品質監査レポート

## 次に修正すべき上位20項目
*重要度 × 影響度 × 発生可能性でランク付け*

1. [ ] **[重大] ハードコードされたJWTシークレット** - src/main/java/com/example/util/JwtUtil.java:25
   - [ ] 影響：認証の完全なバイパスが可能

2. [ ] **[重大] プレーンテキストのデータベース認証情報** - src/main/resources/application.yml:8-9
   - [ ] 影響：露出した場合、データベースへの直接アクセスが可能

3. [ ] **[高] JWTトークンの無期限有効** - src/main/java/com/example/util/JwtUtil.java:35-36
   - [ ] 影響：永続的な認証トークンが攻撃の機会を増大

4. [ ] **[高] CSRF保護の無効化** - src/main/java/com/example/config/SecurityConfig.java:32
   - [ ] 影響：クロスサイトリクエストフォージェリ攻撃が可能

5. [ ] **[高] 在庫更新時のトランザクション境界の欠如** - src/main/java/com/example/service/CheckoutService.java:167
   - [ ] 影響：レースコンディションによる過剰販売

6. [ ] **[高] 安全でないCookie設定** - src/main/java/com/example/util/CookieUtil.java:30-33
   - [ ] 影響：XSS/MITM経由でのCookie窃取

7. [ ] **[高] FLOOR丸めを使用した税計算** - src/main/java/com/example/util/TaxCalculator.java:29
   - [ ] 影響：コンプライアンスに影響する不正確な税計算

8. [ ] **[中] パスワード検証ロジックエラー** - src/main/java/com/example/service/AuthService.java:206
   - [ ] 影響：パスワード変更が失敗または検証をバイパス

9. [ ] **[中] URLに含まれる機密トークン** - src/main/java/com/example/service/AuthService.java:105,155,188
   - [ ] 影響：ログとブラウザ履歴でのトークン露出

10. [ ] **[中] データベースインデックスの欠如** - src/main/resources/schema.sql
    - [ ] 影響：スケール時のクエリパフォーマンス低下

11. [ ] **[中] 価格の整数型保存** - src/main/resources/schema.sql:67
    - [ ] 影響：小数通貨単位を扱えない

12. [ ] **[中] チェックアウトでのN+1クエリパターン** - src/main/java/com/example/service/CheckoutService.java:167
    - [ ] 影響：複数アイテム時のパフォーマンス低下

13. [ ] **[中] 在庫のバージョン管理の欠如** - src/main/java/com/example/service/admin/AdminInventoryService.java:64
    - [ ] 影響：同時アクセス下での更新喪失

14. [ ] **[中] ヘルスチェックエンドポイントの欠如** - アプリケーション構造
    - [ ] 影響：アプリケーションの健全性を監視できない

15. [ ] **[中] 外部キー制約の欠如** - src/main/resources/schema.sql:115
    - [ ] 影響：データ整合性違反が可能

16. [ ] **[中] 一貫性のないエラーレスポンス形式** - src/main/java/com/example/advice/RestExceptionHandler.java
    - [ ] 影響：APIの使いにくさ

17. [ ] **[中] セキュリティ統合テストの欠如** - テストディレクトリ
    - [ ] 影響：セキュリティの後退が検出されない

18. [ ] **[低] プレーンテキストのメールトークン** - src/main/java/com/example/entity/User.java:38
    - [ ] 影響：データベース侵害時のトークン露出

19. [ ] **[低] 構造化ログの欠如** - すべてのサービスファイル
    - [ ] 影響：トラブルシューティングとインシデント対応が困難

20. [ ] **[低] クエリ内のマジックナンバー** - src/main/resources/com/example/mapper/CartMapper.xml:41,67
    - [ ] 影響：メンテナンスの困難さ

## カテゴリ別詳細所見

### 1. セキュリティ/プライバシー問題

#### ハードコードされたJWTシークレット
- [ ] **ファイル**: src/main/java/com/example/util/JwtUtil.java
- [ ] **行**: 25
- [ ] **証拠**: `private static final String SECRET = "myDevSecretKey1234567890_ABCDEFG";`
- [ ] **問題**: ソースコードにJWT署名キーがハードコード
- [ ] **重要度**: 重大
- [ ] **影響**: ソース露出時の認証システム完全侵害
- [ ] **可能性**: バージョン管理にコードがある場合は高
- [ ] **確信度**: 100%

#### 設定内のデータベース認証情報
- [ ] **ファイル**: src/main/resources/application.yml
- [ ] **行**: 8-9
- [ ] **証拠**: 
```yaml
username: root
password: softeni0926
```
- [ ] **問題**: プレーンテキスト設定内のデータベース認証情報
- [ ] **重要度**: 重大
- [ ] **影響**: 設定露出時のデータベース直接アクセス
- [ ] **可能性**: 本番デプロイメントで高
- [ ] **確信度**: 100%

#### JWTトークン有効期限の無効化
- [ ] **ファイル**: src/main/java/com/example/util/JwtUtil.java
- [ ] **行**: 35-36
- [ ] **証拠**: `// .expiration(new Date(now + EXP * 1000))`
- [ ] **問題**: JWTトークンが無期限有効
- [ ] **重要度**: 高
- [ ] **影響**: 長期有効トークンが攻撃機会を無限に増大
- [ ] **可能性**: 本番環境で高
- [ ] **確信度**: 100%

#### CSRF保護の無効化
- [ ] **ファイル**: src/main/java/com/example/config/SecurityConfig.java
- [ ] **行**: 32
- [ ] **証拠**: `http.csrf(c -> c.disable())`
- [ ] **問題**: CSRF保護が完全に無効化
- [ ] **重要度**: 高
- [ ] **影響**: クロスサイトリクエストフォージェリ攻撃が可能
- [ ] **可能性**: 認証ユーザーで中
- [ ] **確信度**: 100%

#### 安全でないCookie設定
- [ ] **ファイル**: src/main/java/com/example/util/CookieUtil.java
- [ ] **行**: 30-33
- [ ] **証拠**:
```java
// ck.setHttpOnly(true);
// ck.setSecure(true);
// ck.setMaxAge(MAX_AGE_SEC);
```
- [ ] **問題**: セキュリティフラグがコメントアウト
- [ ] **重要度**: 高
- [ ] **影響**: XSSまたはMITM攻撃によるCookie窃取
- [ ] **可能性**: Cookieに機密データがある場合は高
- [ ] **確信度**: 100%

#### パスワード比較ロジックエラー
- [ ] **ファイル**: src/main/java/com/example/service/AuthService.java
- [ ] **行**: 206
- [ ] **証拠**: `if (user.getPasswordHash().equals(encoder.encode(req.getCurrentPassword()))){`
- [ ] **問題**: 不正なパスワード検証（一致時にfalseを返す）
- [ ] **重要度**: 中
- [ ] **影響**: パスワード変更が失敗または検証をバイパス
- [ ] **可能性**: ユーザーがパスワード変更時に高
- [ ] **確信度**: 100%

#### URLに含まれる機密トークン（3箇所）
- [ ] **ファイル**: src/main/java/com/example/service/AuthService.java
- [ ] **行**: 105、155、188
- [ ] **証拠**: `String link = "http://localhost:8080/register/verify?token=" + token;`
- [ ] **問題**: URLでトークンが露出（アクセスログに記録）
- [ ] **重要度**: 中
- [ ] **影響**: サーバーログとブラウザ履歴でのトークン露出
- [ ] **可能性**: ログ設定により中
- [ ] **確信度**: 90%

#### ハードコードされたlocalhost URL（3箇所）
- [ ] **ファイル**: src/main/java/com/example/service/AuthService.java
- [ ] **行**: 105、155、188
- [ ] **証拠**: `"http://localhost:8080/..."`
- [ ] **問題**: 本番コードに開発用URLがハードコード
- [ ] **重要度**: 中
- [ ] **影響**: 本番環境でのリンク切れ
- [ ] **可能性**: 本番環境で確実
- [ ] **確信度**: 100%

### 2. トランザクション整合性/信頼性問題

#### 在庫更新時のトランザクション欠如
- [ ] **ファイル**: src/main/java/com/example/service/CheckoutService.java
- [ ] **行**: 167
- [ ] **証拠**: `cart.getItems().forEach(i -> productMapper.decreaseStock(i.getProductId(), i.getQty()));`
- [ ] **問題**: 悲観的ロックなしの在庫減少
- [ ] **重要度**: 高
- [ ] **影響**: レースコンディションが商品の過剰販売につながる
- [ ] **可能性**: 同時負荷下で高
- [ ] **確信度**: 100%

#### 在庫のバージョン管理欠如
- [ ] **ファイル**: src/main/java/com/example/service/admin/AdminInventoryService.java
- [ ] **行**: 64
- [ ] **証拠**: `int rows = adminInventoryMapper.updateInventory(productId, req);`
- [ ] **問題**: 同時更新に対する楽観的ロックなし
- [ ] **重要度**: 中
- [ ] **影響**: 同時管理操作での更新喪失
- [ ] **可能性**: 管理シナリオで中
- [ ] **確信度**: 85%

#### 注文作成の冪等性なし
- [ ] **ファイル**: src/main/java/com/example/service/CheckoutService.java
- [ ] **行**: 156-171
- [ ] **問題**: 注文作成が冪等でない
- [ ] **重要度**: 中
- [ ] **影響**: リトライ時の重複注文
- [ ] **可能性**: ネットワーク問題で中
- [ ] **確信度**: 80%

### 3. パフォーマンス/スケーラビリティ問題

#### データベースインデックスの欠如
- [ ] **ファイル**: src/main/resources/schema.sql
- [ ] **行**: 複数テーブル
- [ ] **問題**: 頻繁にクエリされるカラムにインデックスなし
- [ ] **重要度**: 中
- [ ] **影響**: データ増加に伴うクエリパフォーマンス低下
- [ ] **可能性**: 本番環境で高
- [ ] **確信度**: 90%

#### N+1クエリパターン
- [ ] **ファイル**: src/main/java/com/example/service/CheckoutService.java
- [ ] **行**: 167
- [ ] **証拠**: `cart.getItems().forEach(i -> productMapper.decreaseStock(...))`
- [ ] **問題**: カートアイテムごとの個別クエリ
- [ ] **重要度**: 中
- [ ] **影響**: 複数カートアイテムでのパフォーマンス低下
- [ ] **可能性**: 大きなカートで高
- [ ] **確信度**: 85%

#### 商品リストのページネーション欠如
- [ ] **ファイル**: src/main/java/com/example/controller/ProductController.java
- [ ] **行**: 26-29
- [ ] **問題**: ページネーションなしで全商品を返す
- [ ] **重要度**: 中
- [ ] **影響**: 大規模カタログでのメモリとパフォーマンス問題
- [ ] **可能性**: 商品数増加に伴い高
- [ ] **確信度**: 90%

#### 無制限のクエリ結果
- [ ] **ファイル**: src/main/resources/com/example/mapper/AdminOrderMapper.xml
- [ ] **行**: 8-19
- [ ] **問題**: LIMIT句なしのSELECTクエリ
- [ ] **重要度**: 低
- [ ] **影響**: 大規模結果セットでの潜在的メモリ問題
- [ ] **可能性**: 注文増加に伴い中
- [ ] **確信度**: 85%

### 4. 可観測性/監査問題

#### 構造化ログの欠如
- [ ] **ファイル**: すべてのサービスファイル
- [ ] **問題**: 重要操作のログなし
- [ ] **重要度**: 低
- [ ] **影響**: トラブルシューティングとインシデント対応が困難
- [ ] **可能性**: デバッグ必要時に高
- [ ] **確信度**: 95%

#### 機密操作の監査証跡なし
- [ ] **ファイル**: データベーススキーマ
- [ ] **問題**: パスワード変更、プロファイル更新の監査ログなし
- [ ] **重要度**: 低
- [ ] **影響**: コンプライアンスのための機密ユーザーアクションを追跡できない
- [ ] **可能性**: コンプライアンス要件で高
- [ ] **確信度**: 90%

#### System.out使用（存在する場合）
- [ ] **ファイル**: 各種（検索したが未発見）
- [ ] **問題**: ログの代わりに直接コンソール出力
- [ ] **重要度**: 低
- [ ] **影響**: 本番環境でログがキャプチャされない
- [ ] **可能性**: 低（コードベースで未発見）
- [ ] **確信度**: 100%

### 5. 運用/リカバリ問題

#### ヘルスチェックエンドポイントの欠如
- [ ] **ファイル**: アプリケーション構造
- [ ] **問題**: 監視用ヘルスチェックエンドポイントなし
- [ ] **重要度**: 中
- [ ] **影響**: 本番環境でアプリケーションの健全性を監視できない
- [ ] **可能性**: 本番デプロイメントで高
- [ ] **確信度**: 100%

#### メールのリトライメカニズムなし
- [ ] **ファイル**: src/main/java/com/example/service/AuthService.java
- [ ] **行**: メール送信呼び出し
- [ ] **問題**: メール失敗がリトライされない
- [ ] **重要度**: 低
- [ ] **影響**: 一時的な障害によるメール喪失
- [ ] **可能性**: メールサービスにより中
- [ ] **確信度**: 80%

#### データベースマイグレーション戦略の欠如
- [ ] **ファイル**: src/main/resources/schema.sql
- [ ] **問題**: CREATE TABLE文のみ、マイグレーションツールなし
- [ ] **重要度**: 中
- [ ] **影響**: 本番環境でのスキーマ更新が困難
- [ ] **可能性**: スキーマ変更で高
- [ ] **確信度**: 90%

### 6. コンプライアンス問題

#### FLOOR丸めを使用した税計算
- [ ] **ファイル**: src/main/java/com/example/util/TaxCalculator.java
- [ ] **行**: 29
- [ ] **証拠**: `return incl.setScale(0,RoundingMode.FLOOR).intValue();`
- [ ] **問題**: FLOOR丸めが税計算で金額を失う
- [ ] **重要度**: 高
- [ ] **影響**: 収益とコンプライアンスに影響する不正確な税計算
- [ ] **可能性**: 本番環境で確実
- [ ] **確信度**: 100%

#### 価格の整数型保存
- [ ] **ファイル**: src/main/resources/schema.sql
- [ ] **行**: 67
- [ ] **証拠**: `price INT,`
- [ ] **問題**: 小数通貨単位を扱えない
- [ ] **重要度**: 中
- [ ] **影響**: 整数通貨単位のみに制限
- [ ] **可能性**: 小数通貨をサポートする場合は高
- [ ] **確信度**: 85%

#### 通貨フィールドなし
- [ ] **ファイル**: データベーススキーマ
- [ ] **問題**: 価格の通貨指定なし
- [ ] **重要度**: 低
- [ ] **影響**: 国際取引をサポートできない
- [ ] **可能性**: 国際展開で中
- [ ] **確信度**: 80%

### 7. データモデル/アーキテクチャ問題

#### 外部キー制約の欠如
- [ ] **ファイル**: src/main/resources/schema.sql
- [ ] **行**: 115
- [ ] **問題**: 一部のFK関係が強制されていない
- [ ] **重要度**: 中
- [ ] **影響**: データ整合性違反が可能
- [ ] **可能性**: データ破損で中
- [ ] **確信度**: 90%

#### プレーンテキストのメールトークン
- [ ] **ファイル**: src/main/java/com/example/entity/User.java
- [ ] **行**: 38
- [ ] **証拠**: `private String emailToken;`
- [ ] **問題**: メールトークンがプレーンテキストで保存
- [ ] **重要度**: 低
- [ ] **影響**: データベース侵害時のトークン露出
- [ ] **可能性**: 低いが侵害時に増加
- [ ] **確信度**: 75%

#### NULL許可の重要フィールド
- [ ] **ファイル**: src/main/resources/schema.sql
- [ ] **行**: 各種
- [ ] **問題**: 重要フィールドがNULL値を許可
- [ ] **重要度**: 低
- [ ] **影響**: データ品質問題
- [ ] **可能性**: バグで中
- [ ] **確信度**: 70%

### 8. QA/テスト問題

#### セキュリティ統合テストの欠如
- [ ] **ファイル**: テストディレクトリ
- [ ] **問題**: セキュリティ重視のテストなし
- [ ] **重要度**: 中
- [ ] **影響**: セキュリティの後退が検出されない
- [ ] **可能性**: 開発中に高
- [ ] **確信度**: 90%

#### 限定的なエッジケースカバレッジ
- [ ] **ファイル**: テストファイル
- [ ] **問題**: 境界値テストの欠如
- [ ] **重要度**: 低
- [ ] **影響**: エッジシナリオのバグ
- [ ] **可能性**: 本番環境で中
- [ ] **確信度**: 80%

#### 並行性テストなし
- [ ] **ファイル**: テストディレクトリ
- [ ] **問題**: レースコンディションのテストなし
- [ ] **重要度**: 中
- [ ] **影響**: レースコンディションが検出されない
- [ ] **可能性**: 同時操作で高
- [ ] **確信度**: 85%

### 9. コード品質問題

#### クエリ内のマジックナンバー
- [ ] **ファイル**: src/main/resources/com/example/mapper/CartMapper.xml
- [ ] **行**: 41、67
- [ ] **証拠**: `least(qty + VALUES(qty), 20)`
- [ ] **問題**: ハードコードされた数量制限
- [ ] **重要度**: 低
- [ ] **影響**: メンテナンスの困難さ
- [ ] **可能性**: 低
- [ ] **確信度**: 100%

#### TODOコメント（複数）
- [ ] **ファイル**: 各種ファイル
- [ ] **問題**: TODOでマークされた未完成機能
- [ ] **重要度**: 低
- [ ] **影響**: 潜在的に不完全な機能
- [ ] **可能性**: 低
- [ ] **確信度**: 100%

#### コード重複
- [ ] **ファイル**: 複数のサービスファイル
- [ ] **問題**: 類似のエラー処理パターンが重複
- [ ] **重要度**: 低
- [ ] **影響**: メンテナンス負担
- [ ] **可能性**: 低
- [ ] **確信度**: 70%

### 10. API仕様問題

#### 一貫性のないエラーレスポンス形式
- [ ] **ファイル**: src/main/java/com/example/advice/RestExceptionHandler.java
- [ ] **問題**: 異なる例外タイプが異なる形式を返す
- [ ] **重要度**: 中
- [ ] **影響**: APIの使いにくさとクライアント統合の困難さ
- [ ] **可能性**: API統合時に高
- [ ] **確信度**: 85%

#### 入力検証の欠如
- [ ] **ファイル**: 各種コントローラー
- [ ] **問題**: 一部のエンドポイントで検証欠如
- [ ] **重要度**: 低
- [ ] **影響**: 無効なデータ処理
- [ ] **可能性**: 悪意のある入力で中
- [ ] **確信度**: 75%

#### APIドキュメントなし
- [ ] **ファイル**: コントローラークラス
- [ ] **問題**: OpenAPI/Swaggerドキュメントなし
- [ ] **重要度**: 低
- [ ] **影響**: API統合が困難
- [ ] **可能性**: 外部利用者で高
- [ ] **確信度**: 90%

### 11. 機能/ビジネスロジック問題

#### カート数量制限が設定不可
- [ ] **ファイル**: src/main/resources/com/example/mapper/CartMapper.xml
- [ ] **行**: 41、67
- [ ] **証拠**: `least(qty + VALUES(qty), 20)`
- [ ] **問題**: ハードコードされた最大数量20
- [ ] **重要度**: 低
- [ ] **影響**: ビジネスルールを簡単に調整できない
- [ ] **可能性**: ビジネス変更で中
- [ ] **確信度**: 100%

#### 注文ステータス検証の欠如
- [ ] **ファイル**: src/main/java/com/example/service/admin/AdminOrderService.java
- [ ] **行**: 59
- [ ] **問題**: ステータス変更が有効な遷移か検証されない
- [ ] **重要度**: 中
- [ ] **影響**: 無効な注文状態遷移が可能
- [ ] **可能性**: 手動更新で中
- [ ] **確信度**: 80%

#### 在庫予約なし
- [ ] **ファイル**: src/main/java/com/example/service/CheckoutService.java
- [ ] **問題**: 在庫が予約されない
- [ ] **重要度**: 中
- [ ] **影響**: 同時チェックアウト間での在庫競合
- [ ] **可能性**: 負荷下で高
- [ ] **確信度**: 85%

## 統計サマリー

- [ ] **検出された問題総数**: 71
- [ ] **重大**: 2
- [ ] **高**: 6
- [ ] **中**: 28
- [ ] **低**: 35

## 修正タイムライン

### 即時（本番前）
1. [ ] シークレットを環境変数へ移行
2. [ ] JWT有効期限を有効化
3. [ ] パスワード検証ロジックを修正
4. [ ] Cookieセキュリティフラグを有効化
5. [ ] トランザクション境界を追加

### 第1週
1. [ ] データベースインデックスを追加
2. [ ] ヘルスチェックを実装
3. [ ] 税計算の丸めを修正
4. [ ] CSRF保護を有効化
5. [ ] 重要な欠落制約を追加

### 第1月
1. [ ] 包括的なログを実装
2. [ ] セキュリティテストを追加
3. [ ] 監査証跡を実装
4. [ ] APIドキュメントを追加
5. [ ] リトライメカニズムを実装

### 第1四半期
1. [ ] より良いエラー処理のためリファクタリング
2. [ ] 監視とアラートを実装
3. [ ] 包括的なテストカバレッジを追加
4. [ ] キャッシング戦略を実装
5. [ ] すべてのTODO項目を完了

[Marge]

1. [ ] **ユーザー列挙の脆弱性**
   - [ ] ファイル：`src/main/java/com/example/service/AuthService.java` 行140–143
   - [ ] パスワードリセット時にメールアドレスの存在有無を返す

# 2. トランザクション整合性／信頼性の問題

1. [ ] **メール送信をトランザクション内で実行**
   - [ ] ファイル：`src/main/java/com/example/service/CheckoutService.java` 行139–141
   - [ ] 長時間ロックを引き起こす可能性

2. [ ] **補償ロジックの欠如**
   - [ ] ファイル：同上 行119–142
   - [ ] メール送信失敗時にロールバックしない

# 3. パフォーマンス／スケーラビリティの問題

1. [ ] **N+1 クエリ問題**
   - [ ] ファイル：`src/main/resources/com/example/mapper/ProductMapper.xml` 行92–99
   - [ ] 各商品ごとにサブクエリでレビュー集計

2. [ ] **非効率な税計算**
   - [ ] ファイル：`src/main/java/com/example/util/TaxCalculator.java` 行23–30
   - [ ] `BigDecimal` 演算を毎回実行

# 4. オブザーバビリティ／監査の問題


1. [ ] **ヘルスエンドポイントの未実装**
   - [ ] `pom.xml` に Actuator がない

2. [ ] **構造化ログの未導入**
   - [ ] 全サービス層ファイル

# 5. 運用／リカバリの問題

1. [ ] **サーキットブレイカー未導入**
   - [ ] 外部サービス呼び出し部分

# 6. コンプライアンスの問題
1. [ ] **GDPR 未対応**
   - [ ] データベーススキーマ

2. [ ] **PCI DSS 未対応**
   - [ ] 支払い処理部分

# 7. データモデル／アーキテクチャの問題

1. [ ] **バージョン管理の不足**
   - [ ] `Order` および `Cart` エンティティ
   - [ ] 単純なバージョンチェックでは不十分

2. [ ] **イベントソーシング未導入**
   - [ ] 注文処理部分

# 8. QA／テストの問題

1. [ ] **負荷テスト未実施**

2. [ ] **契約テスト未実装**

# 9. コード品質の問題

1. [ ] **例外ハンドリングの一貫性欠如**
   - [ ] ファイル：`AuthService.java` 行92–94, 142–143, 167–168
   - [ ] 異なる例外型を混在使用

# 10. 仕様の問題

1. [ ] **API バージョニングの未実装**
   - [ ] 全コントローラ

2. [ ] **HTTP ステータスコードの不整合**
   - [ ] リソース作成に 200 を返している

# 11. 機能上の問題

1. [ ] **カート有効期限未実装**
   - [ ] `Cart` エンティティ

2. [ ] **ゲストチェックアウト未対応**
   - [ ] `CheckoutController.java`

